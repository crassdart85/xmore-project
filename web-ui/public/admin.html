<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmore Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>Xmore Admin</h1>
            <p class="subtitle">Market Intelligence Console</p>
        </header>

        <section class="section admin-secret-panel">
            <h2>Admin Access</h2>
            <div class="admin-secret-row">
                <input id="adminSecretInput" type="password" placeholder="Enter ADMIN_SECRET">
                <button id="saveSecretBtn" class="refresh-btn admin-btn">Save</button>
                <span id="secretStatus" class="admin-muted"></span>
            </div>
        </section>

        <!-- ================================================ -->
        <!-- TAB NAVIGATION BAR                               -->
        <!-- ================================================ -->
        <nav class="admin-tab-bar" aria-label="Admin sections">
            <div class="admin-tab-list" id="adminTabList" role="tablist">
                <button class="admin-tab-btn" data-tab="tab-health" role="tab">System Health</button>
                <button class="admin-tab-btn" data-tab="tab-kb" role="tab">Knowledge Base</button>
                <button class="admin-tab-btn" data-tab="tab-reports" role="tab">Reports</button>
                <button class="admin-tab-btn" data-tab="tab-prices" role="tab">Prices</button>
                <button class="admin-tab-btn" data-tab="tab-sources" role="tab">News Sources</button>
                <button class="admin-tab-btn" data-tab="tab-telegram" role="tab">Telegram Feed</button>
                <button class="admin-tab-btn" data-tab="tab-settings" role="tab">Settings</button>
            </div>
            <div class="admin-tab-config-wrap">
                <button class="admin-tab-config-btn" id="tabConfigBtn" title="Show / hide tabs" aria-expanded="false" aria-controls="tabConfigPanel">&#9881;</button>
                <div class="admin-tab-config-panel" id="tabConfigPanel" hidden>
                    <p class="admin-muted" style="margin:0 0 8px;font-size:11px;text-transform:uppercase;letter-spacing:.05em;">Show / hide tabs</p>
                    <div id="tabCheckboxes"></div>
                </div>
            </div>
        </nav>

        <!-- ================================================ -->
        <!-- TAB PANELS                                       -->
        <!-- ================================================ -->

        <section class="section admin-tab-panel" id="tab-health" role="tabpanel">
            <h2>System Health</h2>
            <div class="admin-info-banner" data-hint="tab-health">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> A live snapshot of the system's database and prediction engine.
                    <ul class="admin-info-list">
                        <li><strong>Audit Log</strong> — records every data change automatically. No action needed.</li>
                        <li><strong>Agent Snapshot</strong> — shows the latest win-rate for trading agents. Updates every Friday after predictions run via GitHub Actions.</li>
                        <li>If values show "No data", the first scheduled run hasn't completed yet.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-health">&#10005;</button>
            </div>
            <div class="admin-health-grid">
                <article class="admin-health-card">
                    <h3>Latest Audit Log</h3>
                    <div id="auditHealth" class="admin-health-content no-data">Loading...</div>
                </article>
                <article class="admin-health-card">
                    <h3>Latest Agent Daily Snapshot</h3>
                    <div id="agentHealth" class="admin-health-content no-data">Loading...</div>
                </article>
            </div>
        </section>

        <section class="section admin-tab-panel" id="tab-kb" role="tabpanel">
            <h2>Knowledge Base Upload</h2>
            <div class="admin-info-banner" data-hint="tab-kb">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> Upload market reports, CBE circulars, research PDFs, or scanned images to enrich the trading intelligence pipeline.
                    <ul class="admin-info-list">
                        <li>Supports <strong>PDF, PNG, JPG, WEBP, BMP, TIFF</strong> — up to 25 MB per file.</li>
                        <li>Text is extracted automatically. Arabic and English are both recognised.</li>
                        <li>Scanned images are processed with OCR — text quality depends on scan resolution.</li>
                        <li>Uploaded files appear in the <strong>Reports</strong> tab once processed.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-kb">&#10005;</button>
            </div>
            <div id="dropZone" class="admin-drop-zone" tabindex="0" role="button" aria-label="Upload PDF or image report">
                <p><strong>Drag and drop PDF or image here</strong></p>
                <p>or click to browse</p>
                <input id="fileInput" type="file" accept="application/pdf,.pdf,image/png,.png,image/jpeg,.jpg,.jpeg,image/webp,.webp,image/bmp,.bmp,image/tiff,.tiff,.tif" hidden>
            </div>
            <div id="uploadStatus" class="admin-upload-status"></div>
        </section>

        <section class="section admin-tab-panel" id="tab-reports" role="tabpanel">
            <h2>Report List</h2>
            <div class="admin-info-banner" data-hint="tab-reports">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> All documents uploaded to the knowledge base, with extracted metadata.
                    <ul class="admin-info-list">
                        <li><strong>Status: Processed</strong> — text was extracted successfully and is searchable.</li>
                        <li><strong>Status: Pending</strong> — extraction failed or the file was unreadable (e.g. image-only PDF with no OCR text).</li>
                        <li><strong>Insight</strong> — an auto-generated summary of the document's key topics, tickers, and tone.</li>
                        <li>Language is detected automatically from the extracted text.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-reports">&#10005;</button>
            </div>
            <div class="scrollable-container">
                <table>
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Upload Date</th>
                            <th>Language</th>
                            <th>Status</th>
                            <th>Insight</th>
                        </tr>
                    </thead>
                    <tbody id="reportRows">
                        <tr>
                            <td colspan="5" class="no-data">No reports yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <!-- ================================================ -->
        <!-- CUSTOM NEWS SOURCES                              -->
        <!-- ================================================ -->
        <section class="section admin-tab-panel" id="tab-sources" role="tabpanel">
            <h2>Custom News Sources</h2>
            <div class="admin-info-banner" data-hint="tab-sources">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> Register external sources that the system polls automatically for new articles.
                    <ul class="admin-info-list">
                        <li><strong>RSS Feed</strong> — most news sites provide an RSS URL (e.g. <em>https://example.com/feed</em>). This is the most reliable source type.</li>
                        <li><strong>Single URL</strong> — fetches one specific article page. Use for one-off items.</li>
                        <li><strong>Telegram Public Channel</strong> — enter the channel handle (e.g. <em>t.me/channelname</em>). Only public channels work here.</li>
                        <li><strong>Telegram Bot</strong> — for private channels via a bot. Requires a bot token and chat ID.</li>
                        <li>Use <strong>Pause</strong> to stop fetching without deleting the source or its articles.</li>
                        <li>Use <strong>Fetch Now</strong> to pull new items immediately instead of waiting for the schedule.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-sources">&#10005;</button>
            </div>
            <p class="admin-muted">Add URLs, RSS feeds, or Telegram channels to feed into the sentiment pipeline.</p>

            <!-- Add source form -->
            <div id="addSourcePanel" style="display:none; margin-bottom:16px;">
                <div class="admin-source-form">
                    <div class="admin-form-row">
                        <label for="srcType">Type</label>
                        <select id="srcType">
                            <option value="rss">RSS Feed</option>
                            <option value="url">Single URL (article)</option>
                            <option value="telegram_public">Telegram Public Channel</option>
                            <option value="telegram_bot">Telegram Bot</option>
                            <option value="manual">Manual (no auto-fetch)</option>
                        </select>
                    </div>
                    <div class="admin-form-row">
                        <label for="srcName">Label</label>
                        <input id="srcName" type="text" placeholder="e.g. EGX Telegram Channel">
                    </div>
                    <div class="admin-form-row" id="srcUrlRow">
                        <label for="srcUrl">URL / Channel</label>
                        <input id="srcUrl" type="text" placeholder="https://... or t.me/channelname">
                    </div>
                    <div class="admin-form-row" id="srcBotRow" style="display:none;">
                        <label for="srcBotToken">Bot Token</label>
                        <input id="srcBotToken" type="password" placeholder="1234567:AAB...">
                    </div>
                    <div class="admin-form-row" id="srcChatRow" style="display:none;">
                        <label for="srcChatId">Chat ID</label>
                        <input id="srcChatId" type="text" placeholder="-100123456789">
                    </div>
                    <div class="admin-form-row">
                        <label for="srcLang">Language</label>
                        <select id="srcLang">
                            <option value="auto">Auto-detect</option>
                            <option value="en">English</option>
                            <option value="ar">Arabic</option>
                        </select>
                    </div>
                    <div class="admin-form-row">
                        <label for="srcInterval">Fetch every</label>
                        <select id="srcInterval">
                            <option value="1">1 hour</option>
                            <option value="3">3 hours</option>
                            <option value="6" selected>6 hours</option>
                            <option value="12">12 hours</option>
                            <option value="24">24 hours</option>
                        </select>
                    </div>
                    <div class="admin-form-actions">
                        <button id="saveSrcBtn" class="refresh-btn admin-btn">Save Source</button>
                        <button id="cancelSrcBtn" class="admin-btn" style="background:var(--border-color)">Cancel</button>
                    </div>
                </div>
            </div>

            <button id="addSourceBtn" class="refresh-btn admin-btn" style="margin-bottom:12px;">+ Add Source</button>

            <div class="scrollable-container">
                <table id="sourcesTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>URL / Channel</th>
                            <th>Lang</th>
                            <th>Status</th>
                            <th>Last Fetched</th>
                            <th>Articles</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sourceRows">
                        <tr><td colspan="8" class="no-data">Loading sources…</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="sourceStatus" class="admin-upload-status"></div>
        </section>

        <!-- ================================================ -->
        <!-- LATEST STOCK PRICES                              -->
        <!-- ================================================ -->
        <section class="section admin-tab-panel" id="tab-prices" role="tabpanel">
            <h2>Latest Stock Prices</h2>
            <div class="admin-info-banner" data-hint="tab-prices">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> The most recent closing price and volume for every tracked stock.
                    <ul class="admin-info-list">
                        <li>Data is collected Monday–Friday at 4:30 PM EST via the GitHub Actions workflow.</li>
                        <li>The <strong>Change</strong> column shows the daily move in EGP/USD and as a percentage.</li>
                        <li>Use the search box to filter by ticker or company name.</li>
                        <li>If no data appears, the daily collection job has not run yet today.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-prices">&#10005;</button>
            </div>

            <div class="admin-prices-toolbar">
                <input id="pricesSearch" type="search" placeholder="Filter by ticker or name…" class="admin-prices-search">
                <span id="pricesDate" class="admin-muted"></span>
                <button id="pricesRefreshBtn" class="admin-btn">&#8635; Refresh</button>
            </div>

            <div class="scrollable-container">
                <table id="pricesTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Company</th>
                            <th class="num">Open</th>
                            <th class="num">High</th>
                            <th class="num">Low</th>
                            <th class="num">Close</th>
                            <th class="num">Change</th>
                            <th class="num">Change %</th>
                            <th class="num">Volume</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="priceRows">
                        <tr><td colspan="10" class="no-data">Loading prices…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ================================================ -->
        <!-- TELEGRAM MANUAL FEED                             -->
        <!-- ================================================ -->
        <section class="section admin-tab-panel" id="tab-telegram" role="tabpanel">
            <h2>Telegram Manual Feed</h2>
            <div class="admin-info-banner" data-hint="tab-telegram">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> A manual ingestion lane for content from private Telegram groups or any source that can't be auto-fetched.
                    <ul class="admin-info-list">
                        <li>Paste forwarded message text directly into the text box, or upload a screenshot / PDF.</li>
                        <li>Set a <strong>Source Label</strong> to group these articles together in the sentiment dashboard (e.g. "Telegram — EGX Insiders").</li>
                        <li>Arabic and English are both supported — language is detected automatically.</li>
                        <li>Submitted content goes through the same sentiment pipeline as auto-fetched articles.</li>
                        <li>You can submit text and a file at the same time — both will be processed.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-telegram">&#10005;</button>
            </div>
            <p class="admin-muted">Paste messages from private Telegram groups or upload screenshots and PDFs (Arabic or English). The text is processed through the sentiment pipeline automatically.</p>

            <div class="admin-source-form">
                <div class="admin-form-row">
                    <label for="waSourceName">Source Label</label>
                    <input id="waSourceName" type="text" value="Telegram" placeholder="e.g. Telegram — EGX Group">
                </div>
                <div class="admin-form-row">
                    <label for="waText">Paste text</label>
                    <textarea id="waText" rows="5" placeholder="Paste forwarded message here…" style="width:100%;box-sizing:border-box;resize:vertical;font-family:inherit;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--container-bg);color:var(--text-primary);"></textarea>
                </div>
                <div id="waDropZone" class="admin-drop-zone" tabindex="0" role="button" aria-label="Upload image or PDF">
                    <p><strong>Drag & drop image or PDF</strong></p>
                    <p>or click to browse</p>
                    <input id="waFileInput" type="file" accept="application/pdf,.pdf,image/png,.png,image/jpeg,.jpg,.jpeg,image/webp,.webp,image/bmp,.bmp,image/tiff,.tiff,.tif" hidden>
                </div>
                <p id="waFileName" class="admin-muted" style="min-height:18px;"></p>
                <div class="admin-form-actions">
                    <button id="waSubmitBtn" class="refresh-btn admin-btn">Submit to Pipeline</button>
                </div>
            </div>
            <div id="waStatus" class="admin-upload-status"></div>
        </section>

        <!-- ================================================ -->
        <!-- SETTINGS (frontend tab visibility)               -->
        <!-- ================================================ -->
        <section class="section admin-tab-panel" id="tab-settings" role="tabpanel">
            <h2>Dashboard Settings</h2>
            <div class="admin-info-banner" data-hint="tab-settings">
                <span class="admin-info-icon">&#9432;</span>
                <div class="admin-info-body">
                    <strong>What is this?</strong> Control which tabs are visible in the main trading dashboard for all users on this browser.
                    <ul class="admin-info-list">
                        <li>Toggle any tab off to hide it from the main navigation — it won't load or be accessible.</li>
                        <li><strong>Predictions</strong> is always shown and cannot be hidden.</li>
                        <li>Settings are saved in <code>localStorage</code> — they apply to this browser only.</li>
                        <li>Changes take effect immediately the next time the dashboard is loaded or refreshed.</li>
                    </ul>
                </div>
                <button class="admin-info-dismiss" aria-label="Dismiss" data-dismiss="tab-settings">&#10005;</button>
            </div>

            <div class="admin-settings-card">
                <h3 class="admin-settings-card-title">Frontend Tab Visibility</h3>
                <p class="admin-muted" style="margin-bottom:16px;">Each toggle controls whether the tab appears in the main dashboard navigation.</p>
                <div id="frontendTabToggles" class="admin-settings-toggles"></div>
                <div class="admin-form-actions" style="margin-top:16px;">
                    <button id="resetFrontendTabsBtn" class="admin-btn">Reset to Defaults</button>
                </div>
            </div>
        </section>
    </div>

    <script src="admin.js"></script>
</body>
</html>
